name: Release master PR

# This action will trigger whenever a release is created
on:
  release:
    types: [published]

jobs:
  pull-request:
    runs-on: ubuntu-latest
    steps:
      - name: create-branch
        uses: peterjgrainger/action-create-branch@v2.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: "release-to-master"
      - uses: actions/checkout@v1
      - name: Get the version
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\/v/}
      - name: Get the release notes
        uses: octokit/request-action@v2.x
        id: get_latest_release
        with:
          route: GET /repos/:repository/releases/latest
          repository: ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Get the release note
        id: get_release_note
        run: |
          sudo apt-get install jq
          echo ::set-output name=BODY::${jq -r .body steps.get_latest_release.outputs.data}
      - name: pull-request
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "release-to-master"
          destination_branch: "master"
          pr_title: "Release v${{ steps.get_version.outputs.VERSION }}"
          pr_reviewer: "isilher" # Comma-separated list (no spaces)
          pr_assignee: "isilher" # Comma-separated list (no spaces)
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_body: |
            # 🚀 Release v${{ steps.get_version.outputs.VERSION }}

            ![replace me](https://media.giphy.com/media/sxa1AkXeI95a8/giphy.gif)

            ## 📝 Release notes

            > We blijven hard werken aan de app! Wat is er nieuw in deze versie (${{ steps.get_version.outputs.VERSION }})?
            >
            > - Er zijn wat kleine bugs opgelost. 🐞
            >
            > Heb je vragen of opmerkingen? Neem contact op met klantenservice@reisbalans.nl.

            ${{ steps.get_release_note.outputs.BODY }}
